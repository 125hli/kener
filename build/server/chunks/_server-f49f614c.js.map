{"version":3,"file":"_server-f49f614c.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/today/_server.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport fs from \"fs-extra\";\nimport moment from \"moment-timezone\";\nlet statusObj = {\n  UP: \"api-up\",\n  DEGRADED: \"api-degraded\",\n  DOWN: \"api-down\",\n  NO_DATA: \"api-nodata\"\n};\nfunction parseUptime(up, all) {\n  if (all === 0)\n    return String(\"-\");\n  if (up == all) {\n    return String((up / all * parseFloat(100)).toFixed(0));\n  }\n  return String((up / all * parseFloat(100)).toFixed(4));\n}\nfunction parsePercentage(n) {\n  if (isNaN(n))\n    return \"-\";\n  if (n == 0) {\n    return \"0\";\n  }\n  if (n == 100) {\n    return \"100\";\n  }\n  return n.toFixed(4);\n}\nasync function POST({ request }) {\n  const payload = await request.json();\n  const tz = payload.tz;\n  let _0Day = {};\n  let _90Day = {};\n  let uptime0Day = \"0\";\n  let dailyUps = 0;\n  let dailyDown = 0;\n  let percentage90DaysBuildUp = [];\n  let latency90DaysBuildUp = [];\n  let dailyDegraded = 0;\n  let dailyLatencyBuildUp = [];\n  const now = moment.tz(tz);\n  let minuteFromMidnightTillNow = now.diff(now.clone().startOf(\"day\"), \"minutes\");\n  const midnight90DaysAgo = now.clone().subtract(90, \"days\").startOf(\"day\");\n  for (let i = 0; i <= minuteFromMidnightTillNow; i++) {\n    let eachMin = moment.tz(tz).startOf(\"day\").add(i, \"minutes\").format(\"YYYY-MM-DD HH:mm:00\");\n    _0Day[eachMin] = {\n      timestamp: eachMin,\n      status: \"NO_DATA\",\n      cssClass: statusObj.NO_DATA,\n      latency: \"NA\",\n      index: i\n    };\n  }\n  for (let i = 0; i <= 90; i++) {\n    let eachDay = midnight90DaysAgo.clone().add(i, \"days\").format(\"YYYY-MM-DD\");\n    _90Day[eachDay] = {\n      timestamp: eachDay,\n      UP: 0,\n      DEGRADED: 0,\n      DOWN: 0,\n      uptimePercentage: 0,\n      avgLatency: 0,\n      latency: 0,\n      cssClass: statusObj.NO_DATA,\n      message: \"No Data\"\n    };\n  }\n  let day0 = JSON.parse(fs.readFileSync(payload.day0, \"utf8\"));\n  let _90DayFileData = JSON.parse(fs.readFileSync(payload.day90, \"utf8\"));\n  for (const timestampISO in _90DayFileData) {\n    let cssClass = statusObj.UP;\n    let message = \"OK\";\n    const element = _90DayFileData[timestampISO];\n    if (element === void 0)\n      continue;\n    let currentDay = moment.tz(timestampISO, tz).format(\"YYYY-MM-DD\");\n    if (_90Day[currentDay] === void 0)\n      continue;\n    _90Day[currentDay].UP = element.UP;\n    _90Day[currentDay].DEGRADED = element.DEGRADED;\n    _90Day[currentDay].DOWN = element.DOWN;\n    _90Day[currentDay].avgLatency = element.avgLatency;\n    _90Day[currentDay].latency = element.latency;\n    _90Day[currentDay].uptimePercentage = parseUptime(element.UP + element.DEGRADED, element.UP + element.DEGRADED + element.DOWN);\n    if (element.DEGRADED > 0) {\n      cssClass = statusObj.DEGRADED;\n      message = \"Degraded for \" + element.DEGRADED + \" minutes\";\n    }\n    if (element.DOWN > 0) {\n      cssClass = statusObj.DOWN;\n      message = \"Down for \" + element.DOWN + \" minutes\";\n    }\n    _90Day[currentDay].cssClass = cssClass;\n    _90Day[currentDay].message = message;\n  }\n  for (const timestampISO in day0) {\n    if (Object.hasOwnProperty.call(day0, timestampISO)) {\n      const element = day0[timestampISO];\n      let min = moment.tz(timestampISO, tz).format(\"YYYY-MM-DD HH:mm:00\");\n      let status = element.status;\n      let latency = element.latency;\n      if (_0Day[min] !== void 0) {\n        _0Day[min].status = status;\n        _0Day[min].cssClass = statusObj[status];\n        _0Day[min].latency = latency;\n        dailyUps = status == \"UP\" ? dailyUps + 1 : dailyUps;\n        dailyDown = status == \"DOWN\" ? dailyDown + 1 : dailyDown;\n        dailyDegraded = status == \"DEGRADED\" ? dailyDegraded + 1 : dailyDegraded;\n        dailyLatencyBuildUp.push(latency);\n      }\n    }\n  }\n  for (const key in _90Day) {\n    if (Object.hasOwnProperty.call(_90Day, key)) {\n      const element = _90Day[key];\n      if (element.message == \"No Data\")\n        continue;\n      percentage90DaysBuildUp.push(parseFloat(element.uptimePercentage));\n      latency90DaysBuildUp.push(parseFloat(element.avgLatency));\n    }\n  }\n  uptime0Day = parseUptime(dailyUps + dailyDegraded, dailyUps + dailyDown + dailyDegraded);\n  return json({\n    _0Day,\n    _90Day,\n    uptime0Day,\n    uptime90Day: parsePercentage(percentage90DaysBuildUp.reduce((a, b) => a + b, 0) / percentage90DaysBuildUp.length),\n    avgLatency90Day: latency90DaysBuildUp.length > 0 ? (latency90DaysBuildUp.reduce((a, b) => a + b, 0) / latency90DaysBuildUp.length).toFixed(0) : \"-\",\n    avgLatency0Day: dailyLatencyBuildUp.length > 0 ? (dailyLatencyBuildUp.reduce((a, b) => a + b, 0) / dailyLatencyBuildUp.length).toFixed(0) : \"-\",\n    dailyUps,\n    dailyDown,\n    dailyDegraded\n  });\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}