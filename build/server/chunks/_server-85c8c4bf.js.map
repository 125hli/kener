{"version":3,"file":"_server-85c8c4bf.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/status/_server.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport fs from \"fs-extra\";\nimport { p as public_env } from \"../../../../chunks/shared-server.js\";\nimport \"moment\";\nimport { G as GetNowTimestampUTC, a as GetMinuteStartTimestampUTC, b as GetMinuteStartNowTimestampUTC } from \"../../../../chunks/tool.js\";\nimport Randomstring from \"randomstring\";\nconst API_TOKEN = process.env.API_TOKEN;\nconst API_IP = process.env.API_IP;\nconst checkIfValidTag = function(tag) {\n  let tags = [];\n  let monitors = [];\n  try {\n    monitors = JSON.parse(fs.readFileSync(public_env.PUBLIC_KENER_FOLDER + \"/monitors.json\", \"utf8\"));\n    tags = monitors.map((monitor) => monitor.tag);\n    if (tags.indexOf(tag) == -1) {\n      throw new Error(\"not a valid tag\");\n    }\n  } catch (err) {\n    return false;\n  }\n  return true;\n};\nconst store = function(data, authHeader, ip) {\n  const tag = data.tag;\n  const authToken = authHeader.replace(\"Bearer \", \"\");\n  if (authToken !== API_TOKEN) {\n    return { error: \"invalid token\", status: 401 };\n  }\n  if (API_IP !== void 0 && ip != \"\" && ip !== API_IP) {\n    return { error: \"invalid ip\", status: 401 };\n  }\n  const resp = {};\n  if (data.status === void 0 || [\"UP\", \"DOWN\", \"DEGRADED\"].indexOf(data.status) === -1) {\n    return { error: \"status missing\", status: 400 };\n  }\n  if (data.latency === void 0 || isNaN(data.latency)) {\n    return { error: \"latency missing or not a number\", status: 400 };\n  }\n  if (data.timestampInSeconds !== void 0 && isNaN(data.timestampInSeconds)) {\n    return { error: \"timestampInSeconds not a number\", status: 400 };\n  }\n  if (data.timestampInSeconds === void 0) {\n    data.timestampInSeconds = GetNowTimestampUTC();\n  }\n  data.timestampInSeconds = GetMinuteStartTimestampUTC(data.timestampInSeconds);\n  resp.status = data.status;\n  resp.latency = data.latency;\n  resp.type = \"webhook\";\n  let timestamp = GetMinuteStartNowTimestampUTC();\n  try {\n    if (data.timestampInSeconds > timestamp) {\n      throw new Error(\"timestampInSeconds is in future\");\n    }\n    if (timestamp - data.timestampInSeconds > 90 * 24 * 60 * 60) {\n      throw new Error(\"timestampInSeconds is older than 90days\");\n    }\n  } catch (err) {\n    return { error: err.message, status: 400 };\n  }\n  if (!checkIfValidTag(tag)) {\n    return { error: \"invalid tag\", status: 400 };\n  }\n  let monitors = JSON.parse(fs.readFileSync(public_env.PUBLIC_KENER_FOLDER + \"/monitors.json\", \"utf8\"));\n  const monitor = monitors.find((monitor2) => monitor2.tag === tag);\n  let day0 = {};\n  day0[data.timestampInSeconds] = resp;\n  fs.writeFileSync(public_env.PUBLIC_KENER_FOLDER + `/${monitor.folderName}.webhook.${Randomstring.generate()}.json`, JSON.stringify(day0, null, 2));\n  return { status: 200, message: \"success at \" + data.timestampInSeconds };\n};\nasync function POST({ request }) {\n  const payload = await request.json();\n  const authorization = request.headers.get(\"authorization\");\n  let ip = \"\";\n  try {\n    ip = request.headers.get(\"x-forwarded-for\") || request.socket.remoteAddress || request.headers.get(\"x-real-ip\");\n  } catch (err) {\n    console.log(\"IP Not Found \" + err.message);\n  }\n  let resp = store(payload, authorization, ip);\n  return json(resp, {\n    status: resp.status\n  });\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}